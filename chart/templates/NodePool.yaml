{{- $namespace := .Values.metadata.name }}
{{- $imageset := .Values.hypershift.clusterImageSet }}
{{- $nodepoolconfigs := .Values.hypershift.nodePoolConfigs }}
{{- range .Values.compute }}
{{- $poolconfig:= dict }}
{{- $poolname := .name }}
  {{- range $nodepoolconfigs }}
    {{- if eq .name $poolname }}
      {{- $poolconfig = . }}
    {{- end }}
  {{- end }}
apiVersion: hypershift.openshift.io/v1beta1
kind: NodePool
metadata:
  name: {{ .name | quote }}
  namespace: {{ $namespace | quote }}
  annotations:
    helm.sh/hook-weight: "25"
spec:
  clusterName: {{ $namespace | quote }}
  release:
    image: {{ $imageset | quote }}
  management:
    upgradeType: InPlace
  platform:
    type: "Agent"
    agent:
      agentLabelSelector:
        matchLabels:
          infraenvs.agent-install.openshift.io: {{ .name | quote }}
  config:
{{- if hasKey $poolconfig "configRefs" }}
    {{- $poolconfig.configRefs | toYaml | nindent 4 }}
{{- end }}
{{- if hasKey $poolconfig "reservedCpuSet" }}
    - name: "{{ .name }}-workload-partitioning"
{{- end }}
---
{{- end }}
